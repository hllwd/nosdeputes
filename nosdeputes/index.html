<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>

    <title>Nos d√©putes</title>

    <style>
        body {
            margin: 0;
        }

        /* reset */
        canvas {
            width: 100%;
            height: 100%
        }

        /* dat gui */
        .dg.ac {
            z-index: 2 !important;
        }

        /* popin for selected depute's informations*/
        .message-box {
            z-index: 2;
            position: fixed;
            padding: 10px;
            font: 11px 'Lucida Grande', sans-serif;
        }
    </style>
</head>
<body>

<script src="../bower_components/jquery/dist/jquery.min.js"></script>

<script src="../bower_components/d3/d3.min.js"></script>

<script src="../other_components/Three/three.min.js"></script>
<script src="../other_components/Detector/Detector.js"></script>
<script src="../other_components/THREEx.FullScreen/THREEx.FullScreen.js"></script>
<script src="../bower_components/threex.windowresize/threex.windowresize.js"></script>
<script src="../other_components/OrbitControls/OrbitControls.js"></script>
<script src="../other_components/DAT/dat.gui.min.js"></script>

<div id="container" style="z-index: 1; position: absolute; left:0px; top:0px"></div>

<script>

!function ($, d3, th, thx, win, sortAttribute) {

    // global vars : threejs
    var container, scene, camera, renderer, controls, mouse, projector, gui;
    // global vars : ray intersect
    var targetList = new Array();
    // global vars : data
    var dataDeputes, deputes, scaleYSortAttribute;
    // hemicycle
    var iCol, iLine, maxCol, maxLine, minRadius, maxRadius, scaleRadius, minAngle, maxAngle, scaleAngle, sizeBox;
    // colors
    var colors = {
        ECOLO: 0x00CC00, GDR: 0xFF0033, NI: 0x0000A3, RRDP: 0xFF0033, SRC: 0xFF33CC, UDI: 0x00B3FF, UMP: 0x0033FF
    };
    // positions for sort
    var positions = {
        ECOLO: 1, GDR: 0, NI: 6, RRDP: 2, SRC: 3, UDI: 4, UMP: 5 };
    // message box
    var $messageBox, $messageBoxName, $messageBoxParty, $messageBoxValue, messageBoxTimeout;

    // dom ready callback
    function onDomReady(){
        $messageBox = $('.message-box').hide();
        $messageBoxName = $messageBox.find('#message-box-name');
        $messageBoxParty = $messageBox.find('#message-box-party');
        $messageBoxValue = $messageBox.find('#message-box-value');
    };

    // setup scene
    function setup(rawData) {

        // width
        var w = win.innerWidth;
        // height
        var h = win.innerHeight;
        var viewAngle = 45;
        var aspect = w / h;
        var near = 0.1;
        var far = 20000;
        var light;
        var sphereGeometry;
        var sphereMaterial;
        var sphere;
        var axes;
        var floorTexture;
        var floorMaterial;
        var floorGeometry;
        var floor;
        var skyBoxGeometry;
        var skyBoxMaterial;
        var skyBox;
        var ControlObject = {
            criterion: sortAttribute
        };
        var criterionController;
        // control instance
        var controlInstance = Object.create(ControlObject);
        var controlData = [
            'nb_mandats',
            'semaines_presence',
            'commission_presences',
            'commission_interventions',
            'hemicycle_interventions',
            'hemicycle_interventions_courtes',
            'amendements_signes',
            'amendements_adoptes',
            'rapports',
            'propositions_ecrites',
            'propositions_signees',
            'questions_ecrites',
            'questions_orales'
        ];

        // set up dom ready callback
        $(onDomReady);

        // set hemicycle vars
        setupHemicycle();

        // set data
        dataDeputes = rawData;
        setupData();

        // scene
        scene = new th.Scene();

        // camera
        camera = new th.PerspectiveCamera(viewAngle, aspect, near, far);
        // add the camera to the scene at the default position (0,0,0)
        scene.add(camera);
        // so pull it back (z = 400) and up (y = 100)
        camera.position.set(0, 100, 400);
        // and set the angle towards the scene origin
        camera.lookAt(scene.position);

        // renderer
        if (Detector.webgl) {
            renderer = new th.WebGLRenderer({
                antialias: true
            });
        } else {
            renderer = new th.CanvasRenderer();
        }
        renderer.setSize(w, h);

        // container
        container = document.getElementById('container');
        // attach renderer to the container
        container.appendChild(renderer.domElement);

        // events
        // automatically resize renderer
        thx.WindowResize(renderer, camera);
        // toggle full screen on given key-press
        thx.FullScreen.bindKey({
            charCode: 'm'.charCodeAt(0)
        });

        // controls
        controls = new th.OrbitControls(camera, renderer.domElement);

        // light
        light = new th.PointLight(0xffffff);
        light.position.set(0, 250, 0);
        scene.add(light);

        // light
        light = new th.PointLight(0xffffff);
        light.position.set(0, -250, 0);
        scene.add(light);

        // draw datas
        drawData();

        // axes
        axes = new th.AxisHelper(100);
        scene.add(axes);

        // sky
        // ! make sure the camera's far is big enough to render the sky
        skyBoxGeometry = new th.BoxGeometry(10000, 10000, 10000);
        skyBoxMaterial = new th.MeshBasicMaterial({
            color: 0xffffff,
            side: th.BackSide
        });
        skyBox = new th.Mesh(skyBoxGeometry, skyBoxMaterial);
        scene.add(skyBox);

        // projector
        projector = new th.Projector();

        // gui
        gui = new dat.GUI();
        criterionController = gui.add(controlInstance, 'criterion', controlData);
        gui.open();
        criterionController.onFinishChange(function (value) {
            sortAttribute = value;
            setupData(drawData);
        });

        win.addEventListener('click', onMouseClick, false);

        animate();
    };

    // process datas
    function setupData(cb) {
        // data
        deputes = dataDeputes.deputes.map(function (d) {
            return d.depute;
        });
        // scale for y length
        scaleYSortAttribute = d3.scale.linear()
                .domain(d3.extent(deputes, function (d) {
                    return parseInt(d[sortAttribute]);
                }))
                .rangeRound([0, 100]);
        // we sort deputes
        deputes.sort(function (a, b) {
            if (a.groupe_sigle !== b.groupe_sigle) {
                return positions[a.groupe_sigle] - positions[b.groupe_sigle];
            }
            return a[sortAttribute] - b[sortAttribute];
        });
        if (cb) {
            cb();
        }
    };

    function setupHemicycle() {
        // indexes for assembly loop
        iCol = 0;
        iLine = 0;
        // maxs for assembly loop : 58 * 10
        maxCol = 10;
        maxLine = 58;
        // radius
        minRadius = 150;
        maxRadius = 300;
        // scale radius
        scaleRadius = d3.scale.linear()
                .domain([0, maxCol])
                .rangeRound([minRadius, maxRadius]);
        // angle
        minAngle = -Math.PI / 2;
        maxAngle = Math.PI / 2;
        // scale angle
        scaleAngle = d3.scale.linear()
                .domain([0, maxLine])
                .range([minAngle, maxAngle]);
        // size box
        sizeBox = 7;
    };

    function drawData() {
        console.log('draw datas');
        // loop var
        var currentIndice = 0;
        var currentDepute;
        var currentY = 0;
        var currentLine;
        var currentCol;
        var currentPoint;
        var currentGeometry;
        var currentMaterial;
        var currentCube;

        // first we remove former datas
        targetList.forEach(function(d){
            scene.remove(d);
        });
        targetList = new Array();

        for (iLine = 0; iLine < maxLine; iLine += 1) {
            for (iCol = 0; iCol < maxCol; iCol += 1) {
                currentIndice = iLine * maxCol + iCol;
                if (currentIndice < deputes.length) {
                    currentDepute = deputes[currentIndice];
                    currentY = scaleYSortAttribute(currentDepute[sortAttribute]);
                    currentCol = scaleRadius(iCol);
                    currentLine = scaleAngle(iLine);
                    currentPoint = [
                        Math.cos(currentLine) * currentCol,
                        Math.sin(currentLine) * currentCol
                    ];
                    currentGeometry = new th.BoxGeometry(sizeBox, currentY, sizeBox);
                    currentMaterial = new th.MeshLambertMaterial({ color: colors[currentDepute.groupe_sigle] })
                    currentCube = new th.Mesh(currentGeometry, currentMaterial);
                    currentCube.position.set(currentPoint[0], 1 + currentY / 2, currentPoint[1]);
                    currentCube.userData.depute = currentDepute;
                    scene.add(currentCube);
                    // for intersection purpose
                    targetList.push(currentCube);
                }
            }
        }
    };

    function animate() {
        requestAnimationFrame(animate);
        render();
        update();
    };

    function update() {
        controls.update();
    };

    function render() {
        renderer.render(scene, camera);
    };

    function onMouseClick(event) {
        var vector, ray, intersects;

        // retrive mouse position
        mouse = {
            x: ( event.clientX / window.innerWidth ) * 2 - 1,
            y: -( event.clientY / window.innerHeight ) * 2 + 1
        };

        // create a ray with origin at the mouse position
        // and direction into the scene (camera direction)
        vector = new th.Vector3(mouse.x, mouse.y, 1);
        projector.unprojectVector(vector, camera);
        ray = new th.Raycaster(camera.position, vector.sub(camera.position).normalize());

        // create an array containing all abjects in the scene with wich the ray intersects
        intersects = ray.intersectObjects(targetList);

        // if there is one or more intersections
        if (intersects.length > 0) {
            displaySelectedDepute(intersects[0].object.userData.depute);
        }

    };

    function displaySelectedDepute(depute){
        win.clearTimeout(messageBoxTimeout);
        $messageBoxName.html(depute.nom);
        $messageBoxParty.html(depute.parti_ratt_financier);
        $messageBoxValue.html(depute[sortAttribute]);
        $messageBox.show();
        messageBoxTimeout = win.setTimeout(function(){
            $messageBox.hide();
        }, 3000);
    };

    // retrieve datas
    d3.json('data/nosdeputes.fr_synthese_2014-07-04.json', setup);


}(jQuery, d3, THREE, THREEx, window, 'hemicycle_interventions');


</script>

<div class="message-box">
    <p>Name : <span id="message-box-name"></span></p>
    <p>Party : <span id="message-box-party"></span></p>
    <p>Value : <span id="message-box-value"></span></p>
</div>

</body>
</html>